<?xml version="1.0"?>
<?xml-stylesheet href="modification.xsl" type="text/xsl"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

	ATTENTION: If you are trying to install this manually, you should try
	the package manager.  If it will not work for you, please take a look
	at the following for information on this format:
		http://mods.simplemachines.org/docs/manual-install.php

================================================================================

	Modification files can be used to modify files so that they do what
	your package needs them to do to work properly.

 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<!-- This information needs to be the same as that in the package-info.xml. -->
	<id>Niko:SMFWiki</id>
	<version>{version}</version>

	<!-- Board directory -->
	<file name="$boarddir/index.php">
		<operation>
			<search position="before"><![CDATA[		'im' => array('PersonalMessage.php', 'MessageMain'),]]></search>
			<add><![CDATA[
		'wiki' => array('Wiki.php', 'Wiki'),]]></add>
		</operation>
	</file>

	<!-- Source files -->
	<file name="$sourcedir/Admin.php">
		<operation>
			<search position="after"><![CDATA['current_theme' => array(]]></search>
			<add><![CDATA[
				'wiki' => array(
					'label' => $txt['admin_wiki'],
					'file' => 'WikiAdmin.php',
					'function' => 'WikiAdmin',
					'enabled' => !empty($modSettings['wikiEnabled']),
					'subsections' => array(
						'main' => array($txt['admin_wiki_information']),
						'settings' => array($txt['admin_wiki_settings']),
					),
				),
				]]></add>
		</operation>

		<operation>
			<search position="before"><![CDATA[	$language_files = array(]]></search>
			<add><![CDATA[
	'Wiki', ]]></add>
		</operation>

		<operation>
			<search position="before"><![CDATA[	$include_files = array(]]></search>
			<add><![CDATA[
	'WikiAdmin', ]]></add>
		</operation>

		<operation>
			<search position="before"><![CDATA[		array('ModifyCacheSettings', 'area=serversettings;sa=cache'),]]></search>
			<add><![CDATA[
		array('WikiAdminSettings', 'area=wiki;sa=settings'),]]></add>
		</operation>
	</file>

	<file name="$sourcedir/ManageSettings.php">
		<operation>
			<search position="after"><![CDATA[	);

	// Anyone who would like to add a core feature?]]></search>
			<add><![CDATA[		// wiki = wiki
		'wiki' => array(
			'url' => 'action=admin;area=wiki',
			'settings' => array(
				'wikiEnabled' => 1,
			),
		),]]></add>
		</operation>
	</file>

	<file name="$sourcedir/ManagePermissions.php">
		<operation>
			<search position="before"><![CDATA[			'profile_remote_avatar' => array(false, 'profile', 'use_avatar'),]]></search>

			<add><![CDATA[
			'wiki_access' => array(false, 'wiki', 'wiki'),
			'wiki_edit' => array(false, 'wiki', 'wiki'),
			'wiki_upload' => array(false, 'wiki', 'wiki'),
			'wiki_delete' => array(false, 'wiki', 'administrate'),
			'wiki_admin' => array(false, 'wiki', 'administrate'),]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs.php">
		<operation>
			<search position="before"><![CDATA[	$context['allow_calendar'] = allowedTo('calendar_view') && !empty($modSettings['cal_enabled']);]]></search>
			<add><![CDATA[	$context['allow_wiki'] = !empty($modSettings['wikiEnabled']) && allowedTo('wiki_access');]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[			'search' => array(]]></search>
			<add><![CDATA[			'wiki' => array(
				'title' => $txt['wiki'],
				'href' => $scripturl . '?action=wiki',
				'show' => $context['allow_wiki'] && empty($modSettings['wikiStandalone']),
				'sub_buttons' => array(),
			),]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs-Db-mysql.php">
		<operation>
			<search position="replace"><![CDATA[strpos($db_string, '{db_prefix}') !== false]]></search>
			<add><![CDATA[strpos($db_string, '{db_prefix}') !== false || strpos($db_string, '{wiki_prefix}') !== false]]></add>
		</operation>
		
		<operation>
			<search position="after"><![CDATA[
	if (!isset($matches[2]))]]></search>
			<add><![CDATA[
	if ($matches[1] === 'wiki_prefix')
		return $GLOBALS['wiki_prefix'];
]]></add>
		</operation>
	
		<operation>
			<search position="before"><![CDATA[global $db_connection, $db_prefix;

	$table = str_replace('{db_prefix}', $db_prefix, $table);]]></search>
			<add><![CDATA[
	if (isset($GLOBALS['wiki_prefix']))
		$table = str_replace('{wiki_prefix}', $GLOBALS['wiki_prefix'], $table);
]]></add>
		</operation>
		
		<operation>
			<search position="before"><![CDATA[	// Replace the prefix holder with the actual prefix.
	$table = str_replace('{db_prefix}', $db_prefix, $table);]]></search>
			<add><![CDATA[
	if (isset($GLOBALS['wiki_prefix']))
		$table = str_replace('{wiki_prefix}', $GLOBALS['wiki_prefix'], $table);
]]></add>
		</operation>
	</file>
	
	<!-- Languages -->
	<file name="$languagedir/Modifications.english.php">
		<operation>
			<search position="end" />
			<add><![CDATA[
// SMF Wiki
$txt['wiki'] = 'Wiki';

// Core Features
$txt['core_settings_item_wiki'] = 'Wiki';
$txt['core_settings_item_wiki_desc'] = '';

// Admin menu strings
$txt['admin_wiki'] = 'Wiki';
$txt['admin_wiki_information'] = 'Information';
$txt['admin_wiki_settings'] = 'Settings';

// Permission Names
$txt['permissiongroup_wiki'] = 'Wiki';
$txt['permissionname_wiki_access'] = 'Access Wiki';
$txt['permissionname_wiki_edit'] = 'Edit Pages In Wiki';
$txt['permissionname_wiki_delete'] = 'Delete Pages from Wiki';
$txt['permissionname_wiki_upload'] = 'Upload Files to Wiki';
$txt['permissionname_wiki_admin'] = 'Administrate Wiki';

// Simple permission gropus
$txt['permissiongroup_simple_wiki'] = 'Use Wiki';

// Errors
$txt['cannot_wiki_access'] = 'You are not allowed to access Wiki.';
$txt['cannot_wiki_edit'] = 'You are not allowed to edit pages.';
$txt['cannot_wiki_upload'] = 'You are not allowed to upload files.';
$txt['cannot_wiki_admin'] = 'You are not allowed to administrate Wiki.';
]]></add>
		</operation>
	</file>

</modification>